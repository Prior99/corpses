<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
	<style type="text/less">
		@import url(http://fonts.googleapis.com/css?family=Titillium+Web);
		body {
			margin: 0;
			font-family: "Titillium Web";
			padding: 0;
			background: url('img/black-linen.png');
			height: 100%;
		}
		
		.leaflet-container {
			background : transparent;
		}
		
		div.container {
			position: absolute;
			font-size: 20pt;
			box-shadow: 0px 2px 5px 0px;
			color: black;
			background: white;
			
			table {
				border-spacing: 0;
				border-collapse: separate;
				font-size: inherit;
				tr {
					padding: 2pt 0 2pt 0;
					td {
						border-left: 1px solid grey;
						padding: 0 4pt 0 4pt;
					}
					rd:last-child {
						border: none;
					}
				}
				tr:first-child {
					color: white;
					background: grey;
				}
			}
		}
		
		div.serverstats {
			width: 100%;
			height: 24pt;
			left: 0px;
			top: 0px;
			padding: 4pt 0 4pt 0;
			text-align: center;
			div {
				color: grey;
				width: 100%;
				display: inline;
				margin: 0 8pt 0 8pt;
				span {
					color: black;
				}
			}
		}
		
		div.systemstats {
			width: 100%;
			height: 18pt;
			font-size: 14pt;
			left: 0px;
			bottom: 0px;
			padding: 2pt 0 2pt 0;
			text-align: center;
			div {
				color: grey;
				width: 100%;
				display: inline;
				margin: 0 8pt 0 8pt;
				span {
					color: black;
				}
			}
		}
		
		div.players {
			right: 0px;
			top: 32pt;
			font-size: 14pt;
			tr:first-child {
				font-size: 18pt;
				text-align: center;
			}
		}
		
		div#noplayers {
			text-align: center;
			width: 100%;
		}
		
	</style>
	<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.5/less.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="port.js"></script>
	<script src="js/websocket_client.js"></script>
</head>
<body>
	<div id="map" style="width: 100%; height: 100%"></div>
	<div class="serverstats container">
		<div>
			Time <span id="time"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Players <span id="players"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Zombies <span id="zombies"><img height="20" src="img/loading.gif" /></span> 
		</div>
	</div>
	<div class="systemstats container">
		<div>
			FPS <span id="fps"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Memory <span id="memory"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Chunks <span id="chunks"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Entities <span id="entities"><img height="20" src="img/loading.gif" /></span> 
		</div>
		<div>
			Items <span id="items"><img height="20" src="img/loading.gif" /></span> 
		</div>
	</div>
	<div class="players container" id="players">
		<table id="playerTable">
			<tr>
				<td>Name</td>
				<td style="background: darkgrey;">x</td>
				<td style="background: darkgrey;">y</td>
				<td style="background: darkgrey;">z</td>
				<td>Deaths</td>
				<td>Health</td>
				<td>Kills</td>
				<td>Score</td>
				<td>Age</td>
				<td>Ping</td>
			</tr>
		</table>
		<div id="noplayers">
			No players connected.
		</div>
	</div>
	<script>
		var size = 16;
		var map;
		function initMap(param) {
			var nativeZoom = 4;
			var projection = {
				project: function (latlng) {
					return new L.Point((latlng.lat + 2) / Math.pow(2, nativeZoom), (latlng.lng - 1) / Math.pow(2, nativeZoom));
				},
				unproject: function (point) {
					return new L.LatLng(point.x * Math.pow(2, nativeZoom) - 2, point.y * Math.pow(2, nativeZoom) + 1);
				}
			};
			var crs = L.extend({}, L.CRS.Simple, {
				projection: projection,
				scale: function (zoom) {
					return Math.pow(2, zoom);
				}
			});
			map = L.map('map', {
				center : [0, 0],
				zoomControl: false,
				zoom : 2,
				crs : crs,
				minZoom: 1,
				maxZoom: param.maxZoom,
				layers : [
					L.tileLayer('map/{z}/{x}/{y}.png', {
						tileSize: param.blockSize,
						minZoom: 1,
						maxZoom: 4,
						noWrap: true,
						tms: true,
						continuousWorld : true,
					})
				]
			});
		}
		$.getJSON("map/mapinfo.json", function(json) {
			initMap(json);
			
			var players = {};
			var playerCount = 0;
			
			Websocket.addMessageListener("info", function(obj) {
				$("#players").html(obj.players);
				$("#zombies").html(obj.zombies);
				
				$("#fps").html(obj.fps);
				$("#memory").html(parseInt(obj.memoryUsed*100/obj.memoryMax) + "% of " + obj.memoryMax + "MB");
				$("#chunks").html(obj.chunks);
				$("#entities").html(obj.entitiesLoaded + "/" + obj.entitiesOverall);
				$("#items").html(obj.items);
			});
			Websocket.addMessageListener("spawningWanderingHorde", function(obj) {
				console.log(obj);
			});
			
			function updatePlayer(player) {
				player.tableRow.html(
					"<td>" + player.name + "</td>" +
					"<td style='background: lightgrey;'>" + player.position.x + "</td>" +
					"<td style='background: lightgrey;'>" + player.position.y + "</td>" +
					"<td style='background: lightgrey;'>" + player.position.z + "</td>" +
					"<td>" + player.deaths + "</td>" +
					"<td>" + player.health + "</td>" +
					"<td>" + player.zombieKills + "/" + player.playerKills + "</td>" +
					"<td>" + player.score + "</td>" +
					"<td>" + player.playtime + "min</td>" +
					"<td>" + player.ping + "ms</td>");
			}
			
			Websocket.addMessageListener("listKnownPlayers", function(obj) {
				for(var i in obj) {
					var player = obj[i];
					if(player.online) {
						if(players[player.name] == undefined) {
							players[player.name] = player;
							player.position = {
								x : "?",
								y : "?",
								z : "?",
							};
							player.score = "?";
							player.deaths = "?";
							player.health = "?";
							player.zombieKills = "?";
							player.playerKills = "?";
							player.ping = "?";
							player.tableRow = $("<tr></tr>")
								.appendTo("#playerTable");
							playerCount++;
							updatePlayer(player);
							$("#noplayers").hide();
						}
						else {
							var p = players[player.name];
							p.online = player.online;
							p.playtime = player.playtime;
						}
					}
				}
			});
			Websocket.addMessageListener("getTime", function(obj) {
				$("#time").html("Day " + obj.day + ", " + obj.hour + ":" + obj.minute);
			});
			
			Websocket.addMessageListener("listPlayersExtended", function(obj) {
				console.log(obj);
				for(var i in obj) {
					var player = obj[i];
					var marker;
					var p = players[player.name];
					if(p !== undefined) {
						if(p.marker == undefined) {
							p.marker = L.marker([0, 0]).addTo(map);
						}
						p.marker
							.setLatLng([player.position.x, player.position.z]);
						p.score = player.score;
						p.deaths = player.deaths;
						p.health = player.health;
						p.zombieKills = player.zombieKills;
						p.playerKills = player.playerKills;
						p.position = player.position;
						p.ping = player.ping;
						updatePlayer(p);
					}
				}
			});
			Websocket.addMessageListener("playerConnected", function(obj) {
				console.log(obj);
			});
			Websocket.addMessageListener("playerDisconnected", function(obj) {
				console.log(obj);
				var player;
				if((player = players[obj.name]) !== undefined) {
					map.removeLayer(player.marker);
					player.tableRow.remove();
					players[obj.name] = undefined;
					playerCount--;
					if(playerCount == 0) {
						$("#noplayers").show();
					}
				}
			});
			Websocket.addOpenListener(function() {
				console.log("Websocket connected!");
			});
			Websocket.init();
		});
	</script>
</body>
</html>