<html>
<head>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<style>
		body {
			margin: 0;
			padding: 0;
		}
	</style>
</head>
<body>
	<div id="map" style="width: 100%; height: 100%"></div>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="port.js"></script>
	<script src="js/websocket_client.js"></script>
	<script>
		var size = 16;
		var map;
		function initMap(param) {
			var nativeZoom = 4;
			var projection = {
				project: function (latlng) {
					return new L.Point((latlng.lat + 2) / Math.pow(2, nativeZoom), (latlng.lng - 1) / Math.pow(2, nativeZoom));
				},
				unproject: function (point) {
					return new L.LatLng(point.x * Math.pow(2, nativeZoom) - 2, point.y * Math.pow(2, nativeZoom) + 1);
				}
			};
			var crs = L.extend({}, L.CRS.Simple, {
				projection: projection,
				scale: function (zoom) {
					return Math.pow(2, zoom);
				}
			});
			map = L.map('map', {
				center : [0, 0],
				zoomControl: false,
				zoom : 2,
				crs : crs,
				minZoom: 1,
				maxZoom: param.maxZoom,
				layers : [
					L.tileLayer('map/{z}/{x}/{y}.png', {
						tileSize: param.blockSize,
						minZoom: 1,
						maxZoom: 4,
						noWrap: true,
						tms: true,
						continuousWorld : true,
					})
				]
			});
		}
		$.getJSON("map/mapinfo.json", function(json) {
			initMap(json);
			Websocket.addMessageListener("info", function(obj) {
				console.log(obj);
			});
			Websocket.addMessageListener("spawningWanderingHorde", function(obj) {
				console.log(obj);
			});
			Websocket.addMessageListener("listKnownPlayers", function(obj) {
				console.log(obj);
			});
			Websocket.addMessageListener("getTime", function(obj) {
				console.log(obj);
			});
			var players = {};
			
			Websocket.addMessageListener("listPlayersExtended", function(obj) {
				console.log(obj);
				for(var i in obj) {
					var player = obj[i];
					var marker;
					if(players[player.name] == undefined) {
						players[player.name] = L.marker([0, 0]).addTo(map);
					}
					players[player.name]
						.setLatLng([player.position.x, player.position.z]);
				}
			});
			Websocket.addMessageListener("playerConnected", function(obj) {
				console.log(obj);
			});
			Websocket.addMessageListener("playerDisconnected", function(obj) {
				console.log(obj);
				if(players[obj.name] !== undefined) {
					map.removeLayer(players[obj.name]);
					players[obj.name] = undefined;
				}
			});
			Websocket.addOpenListener(function() {
				console.log("Websocket connected!");
			});
			Websocket.init();
		});
	</script>
</body>
</html>